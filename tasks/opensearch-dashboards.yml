---

- name: Deploy Opensearch through helm
  kubernetes.core.helm:
    name: "{{ osd_opensearch_dashboards_name }}"
    namespace: "{{ osd_opensearch_namespace }}"
    chart_ref: opensearch/opensearch-dashboards
    values_files:
      - '{{ osd_opensearch_dir }}/{{ osd_customvalues }}'

- name: Wait till the Object is created
  kubernetes.core.k8s_info:
    kind: deployment
    wait: yes
    name: "{{ osd_opensearch_dashboards_name }}-opensearch-dashboards"
    namespace: "{{ osd_opensearch_namespace }}"
    wait_sleep: 10
    wait_timeout: 360

- name: Pull down ip config template
  ansible.builtin.template:
    src: "{{ osd_ip_conf }}"
    dest: "{{ osd_opensearch_dir }}"

- name: Expose https port
  kubernetes.core.k8s_service:
    state: present
    name: "{{ osd_opensearch_dashboards_name }}-opensearch-dashboards"
    namespace: "{{ osd_opensearch_namespace }}"
    ports:
      - port: 5601
        protocol: TCP
        targetPort: 5601
    kubeconfig: "{{ osd_opensearch_dir }}/{{ osd_ip_conf }}"
